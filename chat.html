<!DOCTYPE html>
<html>
<head>
  <title>Nepo Chat – Messages</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #1e1e1e;
      color: white;
    }
    #chatHeader {
      background: #00aaff;
      padding: 10px;
      font-size: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #callBtn {
      background: #0088cc;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    #incomingCallBox {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      border: 2px solid #00aaff;
      padding: 15px;
      border-radius: 10px;
      z-index: 9999;
    }
    #incomingCallBox button {
      margin: 5px;
      padding: 8px 10px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #acceptBtn { background: green; }
    #rejectBtn { background: red; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

  <div id="chatHeader">
    <div>👤 <span id="friendName">Friend</span></div>
    <button id="callBtn">📞 Call</button>
  </div>

  <!-- Your chat messages and UI go here -->

  <!-- Incoming Call Box -->
  <div id="incomingCallBox">
    <p>📞 Incoming Call...</p>
    <button id="acceptBtn" onclick="acceptCall()">Accept</button>
    <button id="rejectBtn" onclick="rejectCall()">Reject</button>
  </div>

  <audio id="ringtone" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" type="audio/ogg">
  </audio>

  <script>
    // ✅ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCoRQZYMukYZoqkbY6q0heK3yO9zNFYUfE",
      authDomain: "nepo-chat.firebaseapp.com",
      databaseURL: "https://nepo-chat-default-rtdb.firebaseio.com",
      projectId: "nepo-chat",
      storageBucket: "nepo-chat.appspot.com",
      messagingSenderId: "75918244734",
      appId: "1:75918244734:web:33762641fba78c03a3912f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 🧠 Simulate current friend ID or room ID (replace this with your dynamic system)
    const currentRoomId = "room123";

    // 🔔 Ringtone + Popup Elements
    const ringtone = document.getElementById("ringtone");
    const incomingBox = document.getElementById("incomingCallBox");

    // 📞 Call Button
    document.getElementById("callBtn").addEventListener("click", () => {
      window.location.href = `call.html?room=${currentRoomId}`;
    });

    // 🔁 Detect incoming call (when offer appears)
    db.ref(`calls/${currentRoomId}/offer`).on("value", snap => {
      if (snap.exists()) {
        incomingBox.style.display = "block";
        ringtone.play().catch(e => {});
      }
    });

    function acceptCall() {
      ringtone.pause();
      ringtone.currentTime = 0;
      incomingBox.style.display = "none";
      window.location.href = `call.html?room=${currentRoomId}`;
    }

    function rejectCall() {
      ringtone.pause();
      ringtone.currentTime = 0;
      incomingBox.style.display = "none";
      firebase.database().ref(`calls/${currentRoomId}`).remove();
    }
  </script>

</body>
</html>
