<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nepo Vault</title>
  <style>
    body {
      background: #0e0e0e;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { color: #00ffcc; margin-bottom: 10px; }
    .card {
      background: #1b1b1b;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      margin: 10px 0;
      text-align: center;
      border: 1px solid #333;
    }
    .countdown { color: #ffcc00; font-size: 18px; margin: 10px 0; }
    .reward { margin: 10px 0; font-size: 16px; }
    button {
      background: #00ffcc;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled { background: #555; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>ðŸ’Ž Nepo Vault</h1>
  <div id="subCard" class="card">
    <div><strong>Subscription:</strong> <span id="status">Loading...</span></div>
    <div class="countdown" id="countdown"></div>
  </div>

  <div id="rewardCard" class="card" style="display:none;">
    <div class="reward">Todayâ€™s Reward: â‚¦<span id="rewardAmount">0</span></div>
    <div class="reward" id="tomorrowReward"></div>
    <button id="claimBtn">Claim</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoRQZYMukYZoqkbY6q0heK3yO9zNFYUfE",
      authDomain: "nepo-chat.firebaseapp.com",
      databaseURL: "https://nepo-chat-default-rtdb.firebaseio.com",
      projectId: "nepo-chat",
      storageBucket: "nepo-chat.appspot.com",
      messagingSenderId: "75918244734",
      appId: "1:75918244734:web:33762641fba78c03a3912f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const userId = localStorage.getItem("nepo_user_id");
    if (!userId) {
      alert("Please login first.");
      window.location.href = "signin.html";
    }

    const statusEl = document.getElementById("status");
    const countdownEl = document.getElementById("countdown");
    const rewardCard = document.getElementById("rewardCard");
    const rewardAmountEl = document.getElementById("rewardAmount");
    const tomorrowRewardEl = document.getElementById("tomorrowReward");
    const claimBtn = document.getElementById("claimBtn");

    async function loadVault() {
      const userSnap = await get(ref(db, `users/${userId}`));
      if (!userSnap.exists()) return;
      const data = userSnap.val();

      if (!data.proBadge) {
        statusEl.textContent = "No active Pro subscription";
        return;
      }

      const now = Date.now();
      const expiry = data.proExpiry || now;

      if (now >= expiry) {
        statusEl.textContent = "Subscription expired";
        countdownEl.textContent = "";
        return;
      }

      statusEl.textContent = "Active";
      startCountdown(expiry);

      // Calculate current day in subscription
      const dayPassed = Math.floor((now - data.proStart) / (24*60*60*1000)) + 1;
      const claimedDay = data.vault?.claimedDay ?? 0;

      let todayReward = 0;
      if (claimedDay < dayPassed) {
        todayReward = (dayPassed === 1) ? 400 : 150;
        rewardAmountEl.textContent = todayReward;
        rewardCard.style.display = "block";
        claimBtn.disabled = false;

        // Tomorrowâ€™s preview
        tomorrowRewardEl.textContent = `Tomorrowâ€™s Reward: â‚¦${dayPassed + 1 === 1 ? 400 : 150}`;

        claimBtn.onclick = async () => {
          const freshSnap = await get(ref(db, `users/${userId}`));
          const freshData = freshSnap.val();
          const newBalance = (freshData.balance ?? 0) + todayReward;

          await update(ref(db, `users/${userId}`), {
            balance: newBalance,
            vault: {
              claimedDay: dayPassed,
              lastClaim: now
            }
          });

          alert(`âœ… You claimed â‚¦${todayReward}`);
          claimBtn.disabled = true;
          rewardAmountEl.textContent = "Already claimed today";
        };
      } else {
        rewardCard.style.display = "block";
        rewardAmountEl.textContent = "Already claimed today";
        tomorrowRewardEl.textContent = `Tomorrowâ€™s Reward: â‚¦150`;
        claimBtn.disabled = true;
      }
    }

    function startCountdown(expiry) {
      function updateTimer() {
        const now = Date.now();
        const diff = expiry - now;
        if (diff <= 0) {
          countdownEl.textContent = "Expired";
          return;
        }
        const days = Math.floor(diff / (24*60*60*1000));
        const hours = Math.floor((diff % (24*60*60*1000)) / (60*60*1000));
        const mins = Math.floor((diff % (60*60*1000)) / (60*1000));
        const secs = Math.floor((diff % (60*1000)) / 1000);
        countdownEl.textContent = `Expires in: ${days}d ${hours}h ${mins}m ${secs}s`;
      }
      updateTimer();
      setInterval(updateTimer, 1000);
    }

    loadVault();
  </script>
</body>
</html>
