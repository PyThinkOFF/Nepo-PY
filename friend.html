<!DOCTYPE html>
<html>
<head>
  <title>Nepo Chat ‚Äì Friends</title>
  <style>
    body { background:#121212; color:white; font-family:sans-serif; padding:20px;}
    input, button { padding:10px; margin:5px 0; width:100%; max-width:300px; display:block; border:none; border-radius:6px;}
    input { background:#1e1e1e; color:white;}
    button { background:#00aaff; color:white; cursor:pointer;}
    ul { margin-top:20px; list-style:none; padding:0;}
    li { margin:8px 0; background:#1e1e1e; padding:10px; border-radius:6px; display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:pointer;}
    .verified-badge { width:18px; height:18px; background:#D32F2F; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 6px rgba(211,47,47,0.7);}
    .verified-badge svg { width:12px; height:12px; }
    .nav-btn { background:#4caf50; max-width:200px; text-align:center; margin-top:10px; }
    .friend-info { display:flex; align-items:center; gap:6px; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <h2>‚ûï Add a Friend</h2>
  <input id="friendUid" placeholder="Enter friend's UID">
  <button onclick="searchFriend()">Search</button>
  <button class="nav-btn" onclick="window.location.href='friendrequest.html'">üì© Friend Requests</button>

  <h3>üîç Search Results</h3>
  <ul id="searchResults"></ul>

  <h3>üë• Your Friends</h3>
  <ul id="friendList"></ul>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCoRQZYMukYZoqkbY6q0heK3yO9zNFYUfE",
      authDomain: "nepo-chat.firebaseapp.com",
      databaseURL: "https://nepo-chat-default-rtdb.firebaseio.com",
      projectId: "nepo-chat",
      storageBucket: "nepo-chat.appspot.com",
      messagingSenderId: "75918244734",
      appId: "1:75918244734:web:33762641fba78c03a3912f"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    function createVerifiedBadge() {
      const badge = document.createElement("span");
      badge.classList.add("verified-badge");
      badge.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>`;
      return badge;
    }

    // üîç Search Friend by UID
    function searchFriend() {
      const friendUid = document.getElementById("friendUid").value.trim();
      const resultsList = document.getElementById("searchResults");
      resultsList.innerHTML = "";

      if (!friendUid) return alert("Please enter a friend's UID");

      const currentUser = auth.currentUser;
      if (!currentUser) return alert("‚ö†Ô∏è You must be logged in");
      if (friendUid === currentUser.uid) return alert("You cannot add yourself.");

      db.ref(`users/${friendUid}`).get()
        .then(snapshot => {
          if (!snapshot.exists()) {
            resultsList.innerHTML = "<li>User not found.</li>";
            return;
          }

          const user = snapshot.val();
          const li = document.createElement("li");

          const infoDiv = document.createElement("div");
          infoDiv.classList.add("friend-info");

          const nameSpan = document.createElement("span");
          nameSpan.textContent = user.name || "Unknown User";
          infoDiv.appendChild(nameSpan);

          // ‚úÖ Show verified badge if exists
          db.ref(`verifiedUsers/${friendUid}`).get().then(verifiedSnap => {
            if (verifiedSnap.exists() && verifiedSnap.val() === true) {
              infoDiv.appendChild(createVerifiedBadge());
            }
          });

          li.appendChild(infoDiv);

          // "+" button
          const addBtn = document.createElement("button");
          addBtn.textContent = "+";
          addBtn.onclick = () => {
            window.location.href = `friendrequest.html?uid=${friendUid}`;
          };
          li.appendChild(addBtn);

          resultsList.appendChild(li);
        })
        .catch(err => alert("Error fetching user: " + err.message));
    }

    // üë• Display Accepted Friends
    function displayFriends() {
      const user = auth.currentUser;
      if (!user) return;

      const list = document.getElementById("friendList");
      db.ref(`friends/${user.uid}`).on("value", snapshot => {
        list.innerHTML = "";
        if (!snapshot.exists()) {
          list.innerHTML = "<li>No friends yet.</li>";
          return;
        }

        snapshot.forEach(child => {
          const friendUid = child.key;

          const li = document.createElement("li");
          const infoDiv = document.createElement("div");
          infoDiv.classList.add("friend-info");

          // Get friend name from users/{uid}
          db.ref(`users/${friendUid}`).get().then(friendSnap => {
            const friendData = friendSnap.val();
            const nameSpan = document.createElement("span");
            nameSpan.textContent = friendData?.name || "Unknown Friend";
            infoDiv.appendChild(nameSpan);

            // Add badge if verified
            db.ref(`verifiedUsers/${friendUid}`).get().then(verifiedSnap => {
              if (verifiedSnap.exists() && verifiedSnap.val() === true) {
                infoDiv.appendChild(createVerifiedBadge());
              }
            });

            li.appendChild(infoDiv);
          });

          // Click ‚Üí go to chat room
          li.onclick = () => {
            const roomId = user.uid < friendUid ? `${user.uid}_${friendUid}` : `${friendUid}_${user.uid}`;
            window.location.href = `chat.html?room=${roomId}`;
          };

          list.appendChild(li);
        });
      });
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("‚ö†Ô∏è You are not signed in.");
      } else {
        displayFriends();
      }
    });
  </script>
</body>
</html>
